{% extends "base.html" %}
{% block title %}Assistant IA - Kengni Finance{% endblock %}
{% block page_title %}Assistant IA Conversationnel{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="custom-table p-4" style="min-height: 600px; display: flex; flex-direction: column;">
                <h5 class="mb-4">
                    <i class="fas fa-robot text-primary"></i> Posez-moi vos questions
                </h5>
                
                <div id="chatMessages" style="flex: 1; overflow-y: auto; padding: 1rem; background: var(--accent-color); border-radius: 10px; margin-bottom: 1rem;">
                    <div class="alert alert-info">
                        <strong><i class="fas fa-lightbulb"></i> Exemples de questions:</strong>
                        <ul class="mt-2">
                            <li>Pourquoi j'ai perdu ce mois-ci ?</li>
                            <li>Quelle est ma meilleure stratégie ?</li>
                            <li>Quel est mon score de trader ?</li>
                            <li>Quels sont mes problèmes psychologiques ?</li>
                            <li>Donne-moi des conseils pour améliorer mon trading</li>
                        </ul>
                    </div>
                </div>
                
                <div class="input-group">
                    <input type="text" id="userQuestion" class="form-control" 
                           placeholder="Posez votre question..." 
                           style="background: var(--accent-color); border-color: var(--border-color); color: var(--text-primary);">
                    <button class="btn btn-primary-custom" onclick="askQuestion()">
                        <i class="fas fa-paper-plane"></i> Envoyer
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
async function askQuestion() {
    const input = document.getElementById('userQuestion');
    const question = input.value.trim();
    
    if (!question) return;
    
    const chatMessages = document.getElementById('chatMessages');
    
    // Add user message
    const userMsg = document.createElement('div');
    userMsg.className = 'alert alert-primary mb-2';
    userMsg.innerHTML = `<strong>Vous:</strong> ${question}`;
    chatMessages.appendChild(userMsg);
    
    // Add loading indicator
    const loadingMsg = document.createElement('div');
    loadingMsg.className = 'alert alert-secondary mb-2';
    loadingMsg.innerHTML = '<strong>IA:</strong> <span class="loading"></span> Analyse en cours...';
    chatMessages.appendChild(loadingMsg);
    
    input.value = '';
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    // Send request
    try {
        const response = await fetch('/api/ai-chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({question: question})
        });
        
        const data = await response.json();
        
        // Remove loading message
        loadingMsg.remove();
        
        // Add AI response
        const aiMsg = document.createElement('div');
        aiMsg.className = 'alert alert-success mb-2';
        aiMsg.innerHTML = `<strong><i class="fas fa-robot"></i> IA:</strong><br>${data.answer.replace(/\n/g, '<br>')}`;
        chatMessages.appendChild(aiMsg);
        
        chatMessages.scrollTop = chatMessages.scrollHeight;
    } catch (error) {
        loadingMsg.remove();
        const errorMsg = document.createElement('div');
        errorMsg.className = 'alert alert-danger mb-2';
        errorMsg.innerHTML = '<strong>Erreur:</strong> Impossible de contacter l\'IA';
        chatMessages.appendChild(errorMsg);
    }
}

document.getElementById('userQuestion').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        askQuestion();
    }
});
</script>
{% endblock %}
